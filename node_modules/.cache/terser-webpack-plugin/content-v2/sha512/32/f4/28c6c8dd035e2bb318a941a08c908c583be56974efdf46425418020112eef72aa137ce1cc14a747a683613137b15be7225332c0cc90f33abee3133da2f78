{"code":"!function(e){var t={};function r(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){\"undefined\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:\"Module\"}),Object.defineProperty(e,\"__esModule\",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&\"object\"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,\"default\",{enumerable:!0,value:e}),2&t&&\"string\"!=typeof e)for(var a in e)r.d(n,a,function(t){return e[t]}.bind(null,a));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,\"a\",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p=\"/\",r(r.s=0)}([function(e,t,r){e.exports=r(1)},function(e,t,r){(function(e){let t=r(3)({logger:!0});t.register(r(4),{connectionString:\"postgres://postgres:postgres@localhost:5431/sql\"}),t.post(\"/api/forum/create\",(async function(e,t){const r=await s.getUserByNickname(e.body.user);if(!r.length)return t.code(404),{message:\"cant find user\"};const a=await n.getForumBySlug(e.body.slug);if(a.length)return t.code(409),a[0];let i=e.body;return i.threads=0,i.posts=0,i.userid=r[0].userid,await n.createForum(i),delete i.userid,t.code(201),i})),t.post(\"/api/forum/:slug/create\",(async function(e,t){if(!(await s.getUserByNickname(e.body.author)).length)return t.code(404),{message:\"Cant find user\"};const r=await n.getForumBySlug(e.params.slug);if(!r.length)return t.code(404),{message:\"Cant find forum\"};const i=await a.getThreadByTitle(e.params.title,r[0].id);if(i.length)return t.code(409),i[0];let o=e.body;o.slug=e.params.slug,o.votes=0,o.forumid=r[0].forumid,await a.createThread(o),r[0].threads+=1,await n.modifyForum(r[0]);let u=await a.getThreadByTitle(e.params.title,r[0].forumid);return console.log(u),u})),t.get(\"/api/forum/:slug/details\",async(e,t)=>({})),t.get(\"/api/forum/:slug/threads\",async(e,t)=>({})),t.get(\"/api/forum/:slug/users\",async(e,t)=>({})),t.get(\"/api/post/:id/details\",async(e,t)=>({})),t.post(\"/api/post/:id/details\",async(e,t)=>({})),t.post(\"/api/service/clear\",async(e,t)=>({})),t.get(\"/api/service/status\",async(e,t)=>({})),t.post(\"/api/thread/:slug_or_id/create\",async(e,t)=>({})),t.get(\"/api/thread/:slug_or_id/details\",async(e,t)=>({})),t.get(\"/api/thread/:slug_or_id/posts\",async(e,t)=>({})),t.post(\"/api/thread/:slug_or_id/vote\",async(e,t)=>({})),t.post(\"/api/user/:nickname/create\",(async function(e,t){let r=e.body;r.nickname=e.params.nickname;const n=await s.getUsersByEmailOrNickname(r);if(n.length)return t.code(409),n;return await s.createUser(r),t.code(201),r})),t.get(\"/api/user/:nickname/profile\",(async function(e,t){const r=e.params.nickname,n=await s.getUserByNickname(r);if(n.length)return t.code(200),delete n[0].userid,n[0];return t.code(404),{message:\"Can't find user\"}})),t.post(\"/api/user/:nickname/profile\",(async function(e,t){let r=e.body;r.nickname=e.params.nickname;const n=await s.getUsersByEmailOrNickname(r);if(n.length>1)return t.code(409),{message:\"conflict modify user\"};if(n.length<1)return t.code(404),{message:\"can't find user\"};return await s.modifyUser(r),t.code(200),r}));class n{static async getForumBySlug(e){const r=await t.pg.connect(),{rows:n}=await r.query(\"SELECT forumid, posts, slug, threads, title, userid FROM forums WHERE slug=$1\",[e]);return r.release(),n}static async createForum(e){const r=await t.pg.connect(),{rows:n}=await r.query(\"INSERT INTO forums(posts, slug, threads, title, userid) VALUES($1,$2,$3,$4,$5)\",[e.posts,e.slug,e.threads,e.title,e.userid]);return r.release(),n}static async modifyForum(e){const r=await t.pg.connect(),{rows:n}=await r.query(\"UPDATE forums SET posts=$1, slug=$2, threads=$3, title=$4, userid=$5WHERE slug = $4\",[e.posts,e.slug,e.threads,e.title,e.userid]);return r.release(),n}}class a{static async getThreadByTitle(e,r){const n=await t.pg.connect(),{rows:a}=await n.query(\"SELECT author, created, forum, id, message, slug, title, votes FROM threads WHERE forumid=$1 AND title=$2\",[r,e]);return n.release(),a}static async createThread(e){const r=await t.pg.connect(),{rows:n}=await r.query(\"INSERT INTO threads(author, created, forum, message, slug, title, votes, forumid) VALUES($1,$2,$3,$4,$5,$6,$7,$8)\",[e.author,e.created,e.forum,e.message,e.slug,e.title,e.votes,e.forumid]);return r.release(),n}}class s{static async getUsersByEmailOrNickname(e){const r=await t.pg.connect(),{rows:n}=await r.query(\"SELECT about, email, fullname, nickname FROM users WHERE email=$1 OR nickname=$2\",[e.email,e.nickname]);return r.release(),n}static async getUserByNickname(e){const r=await t.pg.connect(),{rows:n}=await r.query(\"SELECT about, email, fullname, nickname, userId FROM users WHERE nickname=$1\",[e]);return r.release(),n}static async createUser(e){const r=await t.pg.connect(),{rows:n}=await r.query(\"INSERT INTO users(about, email, fullname, nickname) VALUES($1,$2,$3,$4)\",[e.about,e.email,e.fullname,e.nickname]);return r.release(),n}static async modifyUser(e){const r=await t.pg.connect(),{rows:n}=await r.query(\"UPDATE users SET about=$1, email=$2, fullname=$3, nickname=$4WHERE nickname = $4\",[e.about,e.email,e.fullname,e.nickname]);return r.release(),n}}(async()=>{try{await t.listen(8090),t.log.info(`server listening on ${t.server.address().port}`)}catch(r){t.log.error(r),e.exit(1)}})()}).call(this,r(2))},function(e,t){var r,n,a=e.exports={};function s(){throw new Error(\"setTimeout has not been defined\")}function i(){throw new Error(\"clearTimeout has not been defined\")}function o(e){if(r===setTimeout)return setTimeout(e,0);if((r===s||!r)&&setTimeout)return r=setTimeout,setTimeout(e,0);try{return r(e,0)}catch(t){try{return r.call(null,e,0)}catch(t){return r.call(this,e,0)}}}!function(){try{r=\"function\"==typeof setTimeout?setTimeout:s}catch(e){r=s}try{n=\"function\"==typeof clearTimeout?clearTimeout:i}catch(e){n=i}}();var u,c=[],l=!1,f=-1;function d(){l&&u&&(l=!1,u.length?c=u.concat(c):f=-1,c.length&&m())}function m(){if(!l){var e=o(d);l=!0;for(var t=c.length;t;){for(u=c,c=[];++f<t;)u&&u[f].run();f=-1,t=c.length}u=null,l=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===i||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function g(e,t){this.fun=e,this.array=t}function p(){}a.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];c.push(new g(e,t)),1!==c.length||l||o(m)},g.prototype.run=function(){this.fun.apply(null,this.array)},a.title=\"browser\",a.browser=!0,a.env={},a.argv=[],a.version=\"\",a.versions={},a.on=p,a.addListener=p,a.once=p,a.off=p,a.removeListener=p,a.removeAllListeners=p,a.emit=p,a.prependListener=p,a.prependOnceListener=p,a.listeners=function(e){return[]},a.binding=function(e){throw new Error(\"process.binding is not supported\")},a.cwd=function(){return\"/\"},a.chdir=function(e){throw new Error(\"process.chdir is not supported\")},a.umask=function(){return 0}},function(e,t){e.exports=require(\"fastify\")},function(e,t){e.exports=require(\"fastify-postgres\")}]);","extractedComments":[]}